<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OrumGS · Inicio</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script defer src="core.js"></script>
</head>
<body class="bg-gray-100">
<div id="app">
  <!-- Navbar -->
  <nav class="bg-white shadow-md">
    <div class="max-w-6xl mx-auto px-4 h-16 flex justify-between items-center">
      <a href="#" class="text-2xl font-bold text-blue-800">OrumGS</a>
      <div class="flex items-center gap-4">
        <span class="text-sm" v-if="user">Rol: <b>{{ user.rol }}</b></span>
        <button @click="onLogout" class="px-3 py-2 rounded bg-gray-800 text-white">Salir</button>
      </div>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto p-6 space-y-6">
    <!-- Tarjetas de precios cripto -->
    <section class="grid md:grid-cols-3 gap-4">
      <div class="bg-white rounded-xl p-4 shadow">
        <h3 class="font-semibold mb-2">BTCUSDT</h3>
        <div class="text-2xl">{{ prices.bitcoin ?? "..." }}</div>
      </div>
      <div class="bg-white rounded-xl p-4 shadow">
        <h3 class="font-semibold mb-2">ETHUSDT</h3>
        <div class="text-2xl">{{ prices.ethereum ?? "..." }}</div>
      </div>
      <div class="bg-white rounded-xl p-4 shadow">
        <h3 class="font-semibold mb-2">DOGEUSDT</h3>
        <div class="text-2xl">{{ prices.dogecoin ?? "..." }}</div>
      </div>
    </section>

    <!-- Gráficos TradingView -->
    <section class="grid md:grid-cols-3 gap-4">
      <div class="bg-white rounded-xl p-2 shadow"><div id="tv-btc"></div></div>
      <div class="bg-white rounded-xl p-2 shadow"><div id="tv-eth"></div></div>
      <div class="bg-white rounded-xl p-2 shadow"><div id="tv-doge"></div></div>
    </section>
  </main>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const app = Vue.createApp({
    data(){ return { user:null, prices: {} , timer: null }; },
    async mounted(){
      const st = await Core.checkLoginStatus();
      if (!st.ok) { window.location.href = "index.html"; return; }
      this.user = st.user;
      await this.refresh();
      this.timer = setInterval(() => this.refresh(), 15000);

      // Charts
      Core.loadChart("tv-btc", "BINANCE:BTCUSDT");
      Core.loadChart("tv-eth", "BINANCE:ETHUSDT");
      Core.loadChart("tv-doge", "BINANCE:DOGEUSDT");
    },
    beforeUnmount(){ if(this.timer) clearInterval(this.timer); },
    methods:{
      async refresh(){
        try {
          this.prices = await Core.fetchCryptoPrices();
        } catch(e){ Core.showAlert(e.message, "error"); }
      },
      onLogout(){
        Core.logout();
        window.location.href = "index.html";
      }
    }
  });
  app.mount("#app");
});
</script>
</body>
</html>
