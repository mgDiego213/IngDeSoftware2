<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OrumGS · Mercados</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script defer src="core.js"></script>
</head>
<body class="bg-gray-100">
<div id="app">
  <nav class="bg-white shadow-md">
    <div class="max-w-6xl mx-auto px-4 h-16 flex justify-between items-center">
      <a href="Inicio.html" class="text-2xl font-bold text-blue-800">OrumGS</a>
      <button @click="onLogout" class="px-3 py-2 rounded bg-gray-800 text-white">Salir</button>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto p-6 space-y-6">
    <div class="bg-white rounded-xl shadow p-4">
      <h2 class="font-semibold mb-3">Selecciona 3 mercados</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <select v-for="(s, i) in selected" :key="i" v-model="selected[i]" @change="sync"
                class="border rounded p-2">
          <option v-for="o in topList" :key="o.key" :value="o.key">{{ o.label }}</option>
        </select>
      </div>
    </div>

    <!-- Cards de precio -->
    <section class="grid md:grid-cols-3 gap-4">
      <div v-for="c in cards" :key="c.key" class="bg-white rounded-xl p-4 shadow">
        <h3 class="font-semibold mb-2">{{ c.label }}</h3>
        <div class="text-2xl">{{ display[c.key] ?? "..." }}</div>
      </div>
    </section>

    <!-- Gráficos -->
    <section class="grid md:grid-cols-3 gap-4">
      <div v-for="c in cards" :key="c.key" class="bg-white rounded-xl p-2 shadow">
        <div :id="'tv-'+c.key"></div>
      </div>
    </section>
  </main>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const app = Vue.createApp({
    data(){ 
      return { topList: [], selected: ["BTCUSDT","ETHUSDT","DOGEUSDT"], cards: [], display: {}, timer:null };
    },
    async mounted(){
      const st = await Core.checkLoginStatus();
      if (!st.ok) { window.location.href = "index.html"; return; }
      this.topList = await Core.fetchTopList();
      this.sync();
      await this.refresh();
      this.timer = setInterval(()=> this.refresh(), 15000);
    },
    beforeUnmount(){ if (this.timer) clearInterval(this.timer); },
    methods:{
      sync(){
        this.cards = this.selected.map(k => this.topList.find(x => x.key === k)).filter(Boolean);
        // cargar charts
        this.$nextTick(() => {
          for (const c of this.cards) Core.loadChart(`tv-${c.key}`, c.tv_symbol);
        });
      },
      async refresh(){
        try {
          const data = await Core.fetchPrices(this.selected);
          this.display = data;
        } catch(e){ Core.showAlert(e.message, "error"); }
      },
      onLogout(){ Core.logout(); window.location.href = "index.html"; }
    }
  });
  app.mount("#app");
});
</script>
</body>
</html>
