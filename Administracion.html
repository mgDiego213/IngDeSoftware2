<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OrumGS — Administración</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Usa tu CSS existente para la alerta personalizada -->
  <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-100">
<div id="app">
  <!-- NAVBAR -->
  <nav class="bg-white shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center space-x-6">
          <a href="Inicio.html" class="text-2xl font-bold text-blue-800">OrumGS</a>
          <a href="Inicio.html" class="text-gray-900 hover:bg-gray-200 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">Inicio</a>
          <a href="Mercados.html" class="text-gray-900 hover:bg-gray-200 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">Mercados</a>
          <!-- Visible para Dueño, Gerente y Trabajador -->
          <a href="Administracion.html"
             v-if="isLoggedIn && ['Dueño','Gerente','Trabajador'].includes(userRole)"
             class="text-gray-900 bg-gray-200 px-3 py-2 rounded-md text-sm font-medium">Administración</a>
        </div>
        <div class="flex items-center space-x-4">
          <span v-if="isLoggedIn" class="font-semibold text-gray-800">{{ userRole }}</span>
          <button v-if="isLoggedIn" @click="logout"
                  class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Cerrar Sesión</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- CONTENIDO -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <h1 class="text-4xl font-bold text-blue-900 mb-8">Gestión de Usuarios</h1>

    <!-- Visible para lectura a Dueño/Gerente/Trabajador -->
    <div v-if="['Dueño','Gerente','Trabajador'].includes(userRole)">
      <div class="bg-white shadow rounded-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rol</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <tr v-for="user in users" :key="user.id">
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ user.nombre }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ user.email }}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                      :class="badgeClass(user.rol)">
                  {{ user.rol }}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                <!-- Cambiar Rol: Dueño y Gerente (evitan auto-editarse) -->
                <button
                  v-if="['Dueño','Gerente'].includes(userRole) && user.id !== userId"
                  @click="changeUserRole(user.id, user.rol)"
                  class="text-indigo-600 hover:text-indigo-900 mr-4">
                  Cambiar Rol
                </button>
                <!-- Eliminar: Solo Dueño (evita auto-eliminarse) -->
                <button
                  v-if="userRole === 'Dueño' && user.id !== userId"
                  @click="deleteUser(user.id)"
                  class="text-red-600 hover:text-red-900">
                  Eliminar
                </button>
              </td>
            </tr>

            <!-- Estado vacío / cargando -->
            <tr v-if="users.length === 0">
              <td colspan="4" class="px-6 py-8 text-center text-gray-400 text-sm">
                {{ loading ? 'Cargando usuarios…' : 'No hay usuarios para mostrar' }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Sin permisos -->
    <div v-else class="bg-white shadow rounded-lg p-8 text-center text-gray-600">
      No tienes permisos para ver esta sección.
    </div>
  </main>

  <!-- Alerta personalizada -->
  <div v-if="showCustomAlert">
    <div class="alert-backdrop"></div>
    <div class="custom-alert">
      <div class="alert-title">Esta página dice</div>
      <div class="alert-message">{{ customAlertMessage }}</div>
      <button @click="showCustomAlert = false" class="alert-button">Aceptar</button>
    </div>
  </div>
</div>

<script>
  const API_URL = window.location.origin;

  const app = Vue.createApp({
    data() {
      return {
        isLoggedIn: false,
        userRole: '',
        userId: '',
        users: [],
        loading: false,
        showCustomAlert: false,
        customAlertMessage: ''
      };
    },
    methods: {
      showAlert(msg){ this.customAlertMessage = msg; this.showCustomAlert = true; },

      badgeClass(rol){
        if (rol === 'Dueño') return 'bg-green-100 text-green-800';
        if (rol === 'Gerente') return 'bg-blue-100 text-blue-800';
        if (rol === 'Trabajador') return 'bg-yellow-100 text-yellow-800';
        return 'bg-gray-100 text-gray-800'; // Usuario
      },

      checkLoginStatus(){
        const token = localStorage.getItem('token');
        const rol   = localStorage.getItem('rol');
        const uid   = localStorage.getItem('userId');

        this.isLoggedIn = !!token;
        this.userRole   = rol || '';
        this.userId     = uid || '';

        if (!this.isLoggedIn){
          window.location.replace('index.html'); // no logueado → fuera
          return;
        }

        // Cargar usuarios para Dueño/Gerente/Trabajador (solo lectura para Trabajador)
        if (['Dueño','Gerente','Trabajador'].includes(this.userRole)){
          this.loadUsers();
        }
      },

      loadUsers(){
        this.loading = true;
        const token = localStorage.getItem('token');

        fetch(`${API_URL}/usuarios`, {
          method: 'GET',
          headers: { 'Authorization': `Bearer ${token}` }
        })
        .then(async (response) => {
          const data = await response.json();
          if (!response.ok || !Array.isArray(data)) {
            this.users = [];
            this.showAlert(data.message || 'No autorizado');
            return;
          }
          this.users = data;
        })
        .catch((err) => {
          console.error('Error al cargar usuarios:', err);
          this.showAlert('Error al cargar la lista de usuarios');
        })
        .finally(() => { this.loading = false; });
      },

      async changeUserRole(id, currentRole){
        // Dueño y Gerente pueden cambiar roles
        if (!['Dueño','Gerente'].includes(this.userRole)) return;
        const roles = ['Dueño','Gerente','Trabajador','Usuario'];
        const nuevo = prompt('Nuevo rol (Dueño/Gerente/Trabajador/Usuario):', currentRole);
        if (!nuevo || !roles.includes(nuevo)) return this.showAlert('Rol inválido');

        try{
          const token = localStorage.getItem('token');
          const r = await fetch(`${API_URL}/usuarios/${id}/rol`, {
            method:'PUT',
            headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${token}` },
            body: JSON.stringify({ rol: nuevo })
          });
          const d = await r.json();
          if (!r.ok) return this.showAlert(d.message || 'Error al cambiar rol');
          this.showAlert('Rol actualizado correctamente');
          this.loadUsers();
        }catch(e){
          console.error(e);
          this.showAlert('Error al cambiar rol');
        }
      },

      async deleteUser(id){
        // Solo Dueño puede eliminar
        if (this.userRole !== 'Dueño') return;
        if (!confirm('¿Eliminar este usuario?')) return;
        try{
          const token = localStorage.getItem('token');
          const r = await fetch(`${API_URL}/usuarios/${id}`, {
            method:'DELETE',
            headers:{ 'Authorization': `Bearer ${token}` }
          });
          const d = await r.json();
          if (!r.ok) return this.showAlert(d.message || 'Error al eliminar');
          this.users = this.users.filter(u => u.id !== id);
          this.showAlert('Usuario eliminado');
        }catch(e){
          console.error(e);
          this.showAlert('Error al eliminar usuario');
        }
      },

      logout(){
        localStorage.removeItem('token');
        localStorage.removeItem('rol');
        localStorage.removeItem('userId');
        window.location.replace('index.html');
      }
    },
    mounted(){
      this.checkLoginStatus();
    }
  }).mount('#app');
</script>
</body>
</html>
